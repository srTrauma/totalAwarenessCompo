"use strict";(()=>{var e={};e.id=571,e.ids=[571],e.modules={3524:e=>{e.exports=require("@prisma/client")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8781:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,a){return a in r?r[a]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,a)):"function"==typeof r&&"default"===a?r:void 0}}})},2834:(e,r,a)=>{a.r(r),a.d(r,{config:()=>m,default:()=>d,routeModule:()=>l});var s={};a.r(s),a.d(s,{default:()=>u});var o=a(1802),t=a(7153),n=a(8781);let i=new(a(3524)).PrismaClient;async function u(e,r){if("GET"===e.method)try{let{companyId:a}=e.query,s=e.headers.userid;if(!a)return r.status(400).json({message:"El ID de la empresa es obligatorio"});let o=await i.userCompany.findUnique({where:{userId_companyId:{userId:Number(s),companyId:Number(a)}},include:{role:!0}});if(!o||!o.approved)return r.status(403).json({message:"No tienes permisos para ver los miembros de esta empresa"});let t=await i.userCompany.findMany({where:{companyId:Number(a)},include:{user:{select:{id:!0,name:!0,email:!0}},role:!0},orderBy:[{approved:"asc"},{role:{level:"asc"}}]});r.status(200).json(t)}catch(e){console.error("Error al listar miembros:",e),r.status(500).json({message:"Error interno del servidor"})}else if("PUT"===e.method)try{let{membershipId:a,approved:s,roleId:o}=e.body,t=e.headers.userid;if(!a||void 0===s&&!o)return r.status(400).json({message:"Par\xe1metros incompletos para la operaci\xf3n"});let n=await i.userCompany.findUnique({where:{id:a},include:{company:!0}});if(!n)return r.status(404).json({message:"Membres\xeda no encontrada"});let u=await i.userCompany.findUnique({where:{userId_companyId:{userId:Number(t),companyId:n.companyId}},include:{role:!0}}),d=n.company.ownerId===Number(t),m=u?.role?.level!==void 0&&u.role.level<=2;if(!d&&!m)return r.status(403).json({message:"No tienes permisos para realizar esta acci\xf3n"});if(o){let e=await i.role.findUnique({where:{id:o}});if(!e)return r.status(404).json({message:"Rol no encontrado"});if(e.level<=2&&!d)return r.status(403).json({message:"Solo el propietario puede asignar roles de administrador"});let s=await i.userCompany.update({where:{id:a},data:{roleId:o},include:{user:{select:{id:!0,name:!0,email:!0}},role:!0}});return r.status(200).json({message:"Rol actualizado correctamente",membership:s})}if(void 0!==s){if(!s)return await i.userCompany.delete({where:{id:a}}),r.status(200).json({message:"Solicitud rechazada correctamente"});{let e=await i.userCompany.update({where:{id:a},data:{approved:!0},include:{user:{select:{id:!0,name:!0,email:!0}},role:!0}});return r.status(200).json({message:"Solicitud aprobada correctamente",membership:e})}}return r.status(400).json({message:"Operaci\xf3n no especificada"})}catch(e){console.error("Error al procesar la solicitud:",e),r.status(500).json({message:"Error interno del servidor"})}else if("DELETE"===e.method)try{let{membershipId:a}=e.body,s=e.headers.userid;if(!a)return r.status(400).json({message:"El ID de membres\xeda es obligatorio"});let o=await i.userCompany.findUnique({where:{id:a},include:{company:!0}});if(!o)return r.status(404).json({message:"Membres\xeda no encontrada"});let t=o.company.ownerId===Number(s),n=o.userId===Number(s);if(!t&&!n){let e=await i.userCompany.findUnique({where:{userId_companyId:{userId:Number(s),companyId:o.companyId}},include:{role:!0}});if(!(e?.role?.level!==void 0&&e.role.level<=2))return r.status(403).json({message:"No tienes permisos para eliminar este miembro"})}if(o.company.ownerId===o.userId)return r.status(400).json({message:"No se puede eliminar al propietario de la empresa"});await i.userCompany.delete({where:{id:a}}),r.status(200).json({message:"Miembro eliminado correctamente"})}catch(e){console.error("Error al eliminar miembro:",e),r.status(500).json({message:"Error interno del servidor"})}else r.status(405).json({message:"M\xe9todo no permitido"})}let d=(0,n.l)(s,"default"),m=(0,n.l)(s,"config"),l=new o.PagesAPIRouteModule({definition:{kind:t.x.PAGES_API,page:"/api/companies/members",pathname:"/api/companies/members",bundlePath:"",filename:""},userland:s})},7153:(e,r)=>{var a;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,r,a)=>{e.exports=a(145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var a=r(r.s=2834);module.exports=a})();