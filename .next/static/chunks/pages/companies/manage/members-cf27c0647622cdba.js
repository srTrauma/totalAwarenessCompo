(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[950],{4646:function(e,s,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/companies/manage/members",function(){return a(2728)}])},2728:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return d}});var r=a(5893),t=a(7294),i=a(1163),l=a(9008),n=a.n(l),o=a(1029),c=a(1192);function d(){let e=(0,i.useRouter)(),[s,a]=(0,t.useState)(null),[l,d]=(0,t.useState)(null),[m,x]=(0,t.useState)([]),[h,p]=(0,t.useState)(null),[u,g]=(0,t.useState)([]),[b,j]=(0,t.useState)(null),[y,f]=(0,t.useState)(!0),[w,N]=(0,t.useState)(!1),[v,E]=(0,t.useState)(!1),[S,k]=(0,t.useState)(""),[C,I]=(0,t.useState)(null);async function _(s){try{let a=await fetch("/api/companies/detail?companyId=".concat(s),{headers:{userid:localStorage.getItem("user")?JSON.parse(localStorage.getItem("user")).id:""}});if(a.ok){let s=await a.json();d({id:s.id,name:s.name,ownerId:s.owner.id}),I(s.currentUserRole),s.currentUserRole.level>2&&(alert("No tienes permisos para gestionar miembros de esta empresa"),e.push("/Dashboard"))}else{let s=await a.json();k(s.message||"Error al cargar detalles de la empresa"),e.push("/CompanySelection")}}catch(s){console.error("Error:",s),e.push("/CompanySelection")}}async function T(){try{f(!0);let e=await fetch("/api/companies/members?companyId=".concat(l.id),{headers:{userid:s.id.toString()}});if(e.ok){let s=await e.json();x(s)}else{let s=await e.json();k(s.message||"Error al cargar los miembros de la empresa")}}catch(e){console.error("Error al cargar miembros:",e),k("Error al conectar con el servidor")}finally{f(!1)}}async function D(){try{let e=await fetch("/api/roles/list",{headers:{userid:s.id.toString()}});if(e.ok){let s=await e.json();g(s)}else console.error("Error al cargar roles")}catch(e){console.error("Error al cargar roles:",e)}}async function A(e){try{N(!0);let a=await fetch("/api/companies/members",{method:"PUT",headers:{"Content-Type":"application/json",userid:s.id.toString()},body:JSON.stringify({membershipId:e.id,approved:!0})});if(a.ok)await T();else{let e=await a.json();alert(e.message||"Error al aprobar solicitud")}}catch(e){console.error("Error:",e),alert("Error al conectar con el servidor")}finally{N(!1)}}async function O(e){if(confirm("\xbfEst\xe1s seguro de que quieres rechazar esta solicitud?"))try{N(!0);let a=await fetch("/api/companies/members",{method:"PUT",headers:{"Content-Type":"application/json",userid:s.id.toString()},body:JSON.stringify({membershipId:e.id,approved:!1})});if(a.ok)await T();else{let e=await a.json();alert(e.message||"Error al rechazar solicitud")}}catch(e){console.error("Error:",e),alert("Error al conectar con el servidor")}finally{N(!1)}}async function R(e){if(confirm("\xbfEst\xe1s seguro de que quieres eliminar a ".concat(e.user.name," de la empresa?")))try{N(!0);let a=await fetch("/api/companies/members",{method:"DELETE",headers:{"Content-Type":"application/json",userid:s.id.toString()},body:JSON.stringify({membershipId:e.id})});if(a.ok)await T();else{let e=await a.json();alert(e.message||"Error al eliminar miembro")}}catch(e){console.error("Error:",e),alert("Error al conectar con el servidor")}finally{N(!1)}}async function M(){if(h&&b)try{N(!0);let e=await fetch("/api/companies/members",{method:"PUT",headers:{"Content-Type":"application/json",userid:s.id.toString()},body:JSON.stringify({membershipId:h.id,roleId:b})});if(e.ok)E(!1),await T();else{let s=await e.json();alert(s.message||"Error al cambiar rol")}}catch(e){console.error("Error:",e),alert("Error al conectar con el servidor")}finally{N(!1)}}(0,t.useEffect)(()=>{let s=localStorage.getItem("user"),r=localStorage.getItem("selectedCompany");if(!s||!r){e.push("/CompanySelection");return}a(JSON.parse(s)),_(Number(r))},[e]),(0,t.useEffect)(()=>{l&&s&&(T(),D())},[l,s]);let U=e=>{switch(e){case"OWNER":return(0,r.jsx)(c.CvY,{className:"text-yellow-500"});case"ADMIN":return(0,r.jsx)(c.KE5,{className:"text-purple-500"});case"MEMBER":default:return(0,r.jsx)(c.Xws,{className:"text-blue-500"});case"VIEWER":return(0,r.jsx)(c.Xws,{className:"text-gray-500"})}};return y&&!m.length?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n(),{children:(0,r.jsx)("title",{children:"Gesti\xf3n de Miembros | Total Awareness"})}),(0,r.jsx)(o.Z,{}),(0,r.jsx)("div",{className:"flex justify-center items-center h-screen",children:(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n(),{children:(0,r.jsx)("title",{children:"Gesti\xf3n de Miembros | Total Awareness"})}),(0,r.jsx)(o.Z,{}),(0,r.jsxs)("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[(0,r.jsxs)("div",{className:"mb-8 flex justify-between items-center",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Gesti\xf3n de Miembros"}),(0,r.jsxs)("p",{className:"text-gray-600",children:[null==l?void 0:l.name," - ",m.length," miembros"]})]}),(0,r.jsx)("button",{onClick:()=>e.push("/Dashboard"),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Volver al Dashboard"})]}),S&&(0,r.jsx)("div",{className:"p-4 mb-6 bg-red-50 border border-red-200 rounded-md text-red-600",children:S}),m.some(e=>!e.approved)&&(0,r.jsxs)("div",{className:"mb-8",children:[(0,r.jsxs)("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[(0,r.jsx)(c.ziV,{className:"mr-2 text-yellow-500"}),"Solicitudes pendientes"]}),(0,r.jsx)("div",{className:"bg-white shadow-md rounded-lg overflow-hidden",children:(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,r.jsx)("thead",{className:"bg-gray-50",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Usuario"}),(0,r.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Email"}),(0,r.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Fecha solicitud"}),(0,r.jsx)("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),(0,r.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:m.filter(e=>!e.approved).map(e=>(0,r.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,r.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,r.jsx)("div",{className:"font-medium text-gray-900",children:e.user.name})}),(0,r.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,r.jsx)("div",{className:"text-gray-500",children:e.user.email})}),(0,r.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,r.jsx)("div",{className:"text-gray-500",children:new Date(e.joinedAt).toLocaleDateString()})}),(0,r.jsxs)("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:[(0,r.jsxs)("button",{onClick:()=>A(e),disabled:w,className:"text-green-600 hover:text-green-900 mr-4",children:[(0,r.jsx)(c.l_A,{className:"inline mr-1"})," Aprobar"]}),(0,r.jsxs)("button",{onClick:()=>O(e),disabled:w,className:"text-red-600 hover:text-red-900",children:[(0,r.jsx)(c.aHS,{className:"inline mr-1"})," Rechazar"]})]})]},e.id))})]})})})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[(0,r.jsx)(c.I$,{className:"mr-2 text-blue-500"}),"Miembros"]}),m.some(e=>e.approved)?(0,r.jsx)("div",{className:"bg-white shadow-md rounded-lg overflow-hidden",children:(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,r.jsx)("thead",{className:"bg-gray-50",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Usuario"}),(0,r.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Email"}),(0,r.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Rol"}),(0,r.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Desde"}),(0,r.jsx)("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),(0,r.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:m.filter(e=>e.approved).map(e=>(0,r.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,r.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,r.jsxs)("div",{className:"font-medium text-gray-900",children:[e.user.name,e.user.id===(null==l?void 0:l.ownerId)&&(0,r.jsx)("span",{className:"ml-2 text-yellow-500",children:"(Propietario)"})]})}),(0,r.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,r.jsx)("div",{className:"text-gray-500",children:e.user.email})}),(0,r.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("span",{className:"mr-2",children:U(e.role.name)}),(0,r.jsx)("span",{children:e.role.name})]})}),(0,r.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,r.jsx)("div",{className:"text-gray-500",children:new Date(e.joinedAt).toLocaleDateString()})}),(0,r.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.user.id!==(null==l?void 0:l.ownerId)&&(0,r.jsxs)(r.Fragment,{children:[((null==s?void 0:s.id)===(null==l?void 0:l.ownerId)||C&&C.level<e.role.level)&&(0,r.jsxs)("button",{onClick:()=>{p(e),j(e.role.id),E(!0)},disabled:w,className:"text-blue-600 hover:text-blue-900 mr-4",children:[(0,r.jsx)(c.fmQ,{className:"inline mr-1"})," Cambiar rol"]}),(0,r.jsxs)("button",{onClick:()=>R(e),disabled:w,className:"text-red-600 hover:text-red-900",children:[(0,r.jsx)(c.Xm5,{className:"inline mr-1"})," Eliminar"]})]})})]},e.id))})]})})}):(0,r.jsxs)("div",{className:"bg-white shadow-md rounded-lg p-8 text-center",children:[(0,r.jsx)(c.I$,{className:"mx-auto text-gray-400 text-5xl mb-4"}),(0,r.jsx)("p",{className:"text-gray-500",children:"No hay miembros aprobados en esta empresa."})]})]})]}),v&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-md",children:[(0,r.jsxs)("h3",{className:"text-xl font-semibold mb-4",children:["Cambiar rol de ",null==h?void 0:h.user.name]}),(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Selecciona un rol"}),(0,r.jsx)("select",{value:b||"",onChange:e=>j(Number(e.target.value)),className:"w-full p-2 border rounded-md focus:ring-2 focus:border-blue-300",children:u.filter(e=>(null==s?void 0:s.id)===(null==l?void 0:l.ownerId)||e.level>2).map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.name," ",e.description?"- ".concat(e.description):""]},e.id))})]}),(0,r.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,r.jsx)("button",{onClick:()=>E(!1),className:"px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50",children:"Cancelar"}),(0,r.jsx)("button",{onClick:M,disabled:w,className:"px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700",children:w?"Guardando...":"Guardar cambios"})]})]})})]})}a(4390)}},function(e){e.O(0,[365,717,912,833,888,774,179],function(){return e(e.s=4646)}),_N_E=e.O()}]);